<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Trust Score Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <style>
    body { background:#fff; font-family: Arial, sans-serif; }
    .card { border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
    .trust-meter { width:100px; height:100px; margin:auto; display:block; }
    .param-card { text-align:center; padding:15px; border:1px solid #e5e7eb; border-radius:10px; }
    .hedera-card { text-align:center; padding:15px; border:1px solid #e5e7eb; border-radius:10px; background:#f8f9fa; }
    .btn-top { margin-left:10px; }

    /* fallback gradient (unused for bars) */
    .gradient-line {
      height: 10px; border-radius: 5px; width: 100%; margin: 0 auto;
      background: linear-gradient(to right,#ef5350 0%,#ffeb3b 25%,#4caf50 50%,#4285f4 75%,#ef5350 100%);
    }

    .line-wrapper { padding: 8px 12px; }

    /* Fixed semantic bar colors */
    .bar-green { background-color:#22c55e !important; }       /* emerald-ish */
    .bar-pink  { background-color:#ffd6e7 !important; }       /* light pastel pink */
    .bar-bg    { background-color:#e9ecef; }                  /* track bg (bootstrap default) */

    @media (max-width:767px){
      .trust-meter { width:90px; height:90px; }
    }
  </style>
  <style>
  #componentBreakdown { width:100% !important; height:280px !important; }
</style>

</head>
<body class="p-4">
  <!-- ðŸ”¹ SafiHash Header (paste just below <body class="p-4"> ) -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top" style="background:#0b3a6d;">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="/">
      <i class="bi bi-shield-lock me-2"></i>SafiHash
    </a>
    <span class="navbar-text small d-none d-md-inline">
      Trust Score Dashboard
    </span>
    <div class="ms-auto d-flex align-items-center gap-2">
      <button id="logout-btn" class="btn btn-outline-light btn-sm">
        <i class="bi bi-box-arrow-right me-1"></i> Logout
      </button>
    </div>
  </div>
</nav>

 <div class="container py-4">
<!-- Top Bar -->
<div class="d-flex justify-content-between align-items-start mb-4">
<div>
  <div class="fw-bold fs-5" id="topBarTitle">Trustscore Analysis</div>
  <div id="userInfo">User ID: {{ user_id }}</div>
  <div class="text-muted small">Group: {{ group_name }} (slug: {{ group_slug }})</div>
</div>

<div>
  <button id="btnRefresh" class="btn btn-outline-secondary btn-sm btn-top">Refresh</button>
  <button id="btnExport" class="btn btn-outline-primary btn-sm btn-top">Export PDF</button>
  <button id="btnBack" class="btn btn-success btn-sm btn-top">Back</button>
</div>
</div>


<!-- FIRST ROW: Donut -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card p-3 text-center" id="donutCard">
      <h5 class="mb-3">Overall Trust Score</h5>
      <canvas id="trustMeter" class="trust-meter" width="120" height="120"></canvas>
      <div class="fw-bold mt-2" id="trustLabel"></div>
      <div class="line-wrapper mt-3" style="padding:8px 12px; overflow:visible;">
        <canvas id="trustLine" style="display:block;width:100%;border-radius:6px;"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- SECOND ROW: Parameters (with ultra-clear tooltips) -->
<div class="row row-cols-2 row-cols-md-5 g-3 mb-4" id="paramGrid">

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Deposit Consistency">
      <i class="bi bi-bank fs-4 text-primary"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Deposit Consistency
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="Last 6 months: how steady and how much you saved.">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Repayment Timeliness">
      <i class="bi bi-clock-history fs-4 text-info"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Repayment Timeliness
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="How often your EMIs were paid on or before the due date.">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="On-time Repayments Ratio">
      <i class="bi bi-alarm fs-4 text-secondary"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        On-time Repayments
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="Payments that reached on time, out of all scheduled ones.">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Voting Participation">
      <i class="bi bi-people fs-4 text-warning"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Voting Participation
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="How often you took part in group votes.">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Loan Request Frequency">
      <i class="bi bi-cash-coin fs-4 text-success"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Loan Requests
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="Are you asking for loans more than most members? (More = lower score; zero = neutral)">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Disbursal Timeliness">
      <i class="bi bi-currency-exchange fs-4 text-primary"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Loan Disbursal
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="How quickly approved loans were disbursed to you. (No loans = N/A)">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Self-Repayment Rate">
      <i class="bi bi-wallet2 fs-4 text-success"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Self Repayments
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="Repayments you made yourself (not by someone else).">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Third-Party Payment Flag">
      <i class="bi bi-person-check fs-4 text-secondary"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Third-party Repayments
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="Fewer outsider-paid installments means a better score. (We check audit flags)">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Loan Approval Rate">
      <i class="bi bi-check-circle fs-4 text-success"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Loan Approval
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="How many of your loan requests got approved.">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="col">
    <div class="card p-3 text-center shadow-sm" data-metric="Profit Contribution Share">
      <i class="bi bi-graph-up fs-4 text-primary"></i>
      <h2 class="fw-bold mb-0">--%</h2>
      <small class="text-muted">
        Profit Share
        <i class="bi bi-info-circle ms-1 text-secondary"
           data-bs-toggle="tooltip"
           title="Your share of total deposits in this group. (Higher share = higher score)">
        </i>
      </small>
      <div class="progress mt-2" style="height:6px;">
        <div class="progress-bar" style="width:0%"></div>
      </div>
    </div>
  </div>

</div>



<!-- Hedera Activity + Trend -->
<div class="row g-4 mb-4">
  <!-- LEFT COL: Hedera Activity -->
  <div class="col-md-6">
    <div class="card p-3 h-100">
<h5 class="mb-3 text-center">Hedera Services Used in Trust Score Journey</h5>
<div class="text-center mb-3" style="font-size:13px;color:gray;">
  Key Hedera network features that every memberâ€™s activity relies on
</div>


      <!-- 6 static cards -->
      <div class="row g-3 text-center">
        <div class="col-6">
          <div class="d-flex flex-column align-items-center justify-content-center p-3 shadow-sm rounded bg-white h-100">
            <i class="bi bi-link-45deg text-success fs-3 mb-2"></i>
            <div class="fw-bold">Hedera Wallet Linked</div>
            <small class="text-success">âœ… Successful</small>
          </div>
        </div>
        <div class="col-6">
          <div class="d-flex flex-column align-items-center justify-content-center p-3 shadow-sm rounded bg-white h-100">
            <i class="bi bi-file-earmark-lock2 text-primary fs-3 mb-2"></i>
            <div class="fw-bold">KYC File Stored</div>
            <small class="text-success">âœ… On Hedera</small>
          </div>
        </div>
        <div class="col-6">
          <div class="d-flex flex-column align-items-center justify-content-center p-3 shadow-sm rounded bg-white h-100">
            <i class="bi bi-shield-lock text-warning fs-3 mb-2"></i>
            <div class="fw-bold text-center">Trust Score Updates</div>
            <small class="text-success">âœ… Smart Contract</small>
          </div>
        </div>
        <div class="col-6">
          <div class="d-flex flex-column align-items-center justify-content-center p-3 shadow-sm rounded bg-white h-100">
            <i class="bi bi-currency-bitcoin text-info fs-3 mb-2"></i>
            <div class="fw-bold">HTS Token Txns</div>
            <small class="text-success">âœ… Verified</small>
          </div>
        </div>
        <!-- ðŸ”¹ New Card 1 -->
        <div class="col-6">
          <div class="d-flex flex-column align-items-center justify-content-center p-3 shadow-sm rounded bg-white h-100">
            <i class="bi bi-coin text-danger fs-3 mb-2"></i>
            <div class="fw-bold">HBAR Fees</div>
            <small class="text-success">âœ… Paid</small>
          </div>
        </div>
        <!-- ðŸ”¹ New Card 2 -->
        <div class="col-6">
          <div class="d-flex flex-column align-items-center justify-content-center p-3 shadow-sm rounded bg-white h-100">
            <i class="bi bi-broadcast text-secondary fs-3 mb-2"></i>
            <div class="fw-bold">Consensus Events</div>
            <small class="text-success">âœ… Recorded</small>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- RIGHT COL: Score Trend Graph -->
<div class="col-md-6">
  <div class="card p-3 h-100">
    
    <h5 class="text-center mb-3">Trust Score Progress</h5>
    
    <div class="text-center mb-3" style="font-size:13px;color:gray;">
      Daily changes in the memberâ€™s trust score across the last 30 days.
    </div>

    <!-- ðŸ”¹ Emoji info cards (all in one row) -->
    <div class="row row-cols-4 g-2 text-center mb-5">
      <div class="col">
        <div class="d-flex flex-column align-items-center justify-content-center p-2 shadow-sm rounded bg-white h-100">
          <div style="font-size:20px;">ðŸ“ˆ</div>
          <div class="fw-bold small">Growth</div>
        </div>
      </div>
      <div class="col">
        <div class="d-flex flex-column align-items-center justify-content-center p-2 shadow-sm rounded bg-white h-100">
          <div style="font-size:20px;">ðŸ“‰</div>
          <div class="fw-bold small">Decline</div>
        </div>
      </div>
      <div class="col">
        <div class="d-flex flex-column align-items-center justify-content-center p-2 shadow-sm rounded bg-white h-100">
          <div style="font-size:20px;">ðŸ“Š</div>
          <div class="fw-bold small">Trend</div>
        </div>
      </div>
      <div class="col">
        <div class="d-flex flex-column align-items-center justify-content-center p-2 shadow-sm rounded bg-white h-100">
          <div style="font-size:20px;">ðŸ”„</div>
          <div class="fw-bold small">Update</div>
        </div>
      </div>
    </div>
    <div id="ctx"
     data-user-id="{{ user_id }}"
     data-group-id="{{ group_id }}"
     data-group-slug="{{ group_slug }}"></div>


    <!-- Chart -->
    <div class="chart-box" style="height:280px; width:100%; position:relative;">
      <canvas id="scoreTrend"></canvas>
    </div>

  </div>
</div>



<!-- Graphs Row -->
<div class="row g-4 mb-4">
<!-- LEFT COL: Loan vs Repayment -->
<div class="col-md-6">
  <div class="card p-3 h-100">
    <h5 class="mb-3 text-center">Loans vs Repayments</h5>
    <div class="text-center mb-3" style="font-size:13px;color:gray;">
      Each loanâ€™s original amount, total repaid, and net balance due.
    </div>
    <div style="height:280px; position:relative;">
      <canvas id="loanVsRepayment"></canvas>
    </div>
  </div>
</div>
  <!-- RIGHT COL: Component Breakdown -->
  <div class="col-md-6">
    <div class="card p-3 h-100 text-center">
      <h5 class="mb-3 text-center">Component Breakdown</h5>
      <div class="text-center mb-3" style="font-size:13px;color:gray;">
        Percentage contribution of each parameter to the overall trust score.
      </div>
      <canvas id="componentBreakdown" style="margin:auto;display:block;height:280px;"></canvas>
    </div>
  </div>

</div>


<!-- MAIN SCRIPT -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_URL = `/api/coops/{{ group_slug }}/trustscore/weekly/{{ user_id }}`;

  const trustLabelEl = document.getElementById('trustLabel');
  const donutCanvas = document.getElementById('trustMeter');
  const lineCanvas = document.getElementById('trustLine');
  const lineWrapper = lineCanvas.parentElement;
  const paramCards = Array.from(document.querySelectorAll('#paramGrid .card'));
  const refreshBtn = document.getElementById('btnRefresh');


  // Fixed semantic color map
  const NEGATIVE_METRICS = new Set([]);
  const POSITIVE_COLOR_CLASS = 'bar-green';
  const NEGATIVE_COLOR_CLASS = 'bar-pink';

  let donutChart = null;

// ---------- Update param cards (fixed colors) ----------
function updateParamCards(params) {
  const COLOR_MAP = {
    "Deposit Consistency": "bg-primary",
    "Repayment Timeliness": "bg-info",
    "On-time Repayments Ratio": "bg-success",
    "Voting Participation": "bg-warning",
    "Loan Request Frequency": "bg-success",
    "Disbursal Timeliness": "bg-primary",
    "Self-Repayment Rate": "bg-success",
    "Third-Party Payment Flag": "bg-secondary",
    "Loan Approval Rate": "bg-success",
    "Profit Contribution Share": "bg-info"
  };

  paramCards.forEach(card => {
    const key = card.dataset.metric;
    const raw = (params || {})[key];
    const valueEl = card.querySelector('h2');
    const pbar = card.querySelector('.progress-bar');
    if (!valueEl || !pbar) return;

    // reset color
    pbar.className = 'progress-bar';
    const colorClass = COLOR_MAP[key] || "bg-success";
    pbar.classList.add(colorClass);

    // handle N/A
    if (raw === null || raw === undefined || Number.isNaN(Number(raw))) {
      valueEl.innerText = 'N/A';
      pbar.style.width = '0%';
      return;
    }

    const pct = Math.max(0, Math.min(100, Math.round(Number(raw) || 0)));
    valueEl.innerText = `${pct}%`;
    pbar.style.width = `${pct}%`;
  });
}


  // ---------- Donut ----------
  function renderDonut(score) {
    if (donutChart) { donutChart.destroy(); donutChart = null; }
    const ctx = donutCanvas.getContext('2d');
    const cx = donutCanvas.width / 2;
    const cy = donutCanvas.height / 2;
    const conic = ctx.createConicGradient(-Math.PI/2, cx, cy);
    conic.addColorStop(0.00, '#ef5350');
    conic.addColorStop(0.25, '#ffeb3b');
    conic.addColorStop(0.50, '#4caf50');
    conic.addColorStop(0.75, '#4285f4');
    conic.addColorStop(1.00, '#ef5350');

    donutChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Score','Remaining'],
        datasets: [{
          data: [score, Math.max(0, 100 - score)],
          backgroundColor: [conic, '#e5e7eb'],
          borderWidth: 0,
        }]
      },
      options: {
        cutout: '75%',
        plugins: { legend: { display: false } },
        responsive: false,
        animation: { duration: 400 }
      },
      plugins: [{
        id: 'centerText',
        beforeDraw: (chart) => {
          const { ctx, chartArea: { width, height } } = chart;
          ctx.save();
          ctx.font = 'bold 36px Arial';
          ctx.fillStyle = '#333';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(String(score), width / 2, height / 2);
          ctx.restore();
        }
      }]
    });

    let remark = "";
    if (score <= 25) remark = "Very Low Trust";
    else if (score <= 50) remark = "Moderate Trust";
    else if (score <= 75) remark = "Good Trust";
    else if (score <= 90) remark = "Strong Trust";
    else remark = "Excellent Trust";
    trustLabelEl.innerText = remark;
  }

  // ---------- Gradient pointer line ----------
  function drawTrustLine(score) {
    const dpr = window.devicePixelRatio || 1;
    const wrapperStyle = getComputedStyle(lineWrapper);
    const paddingLeft = parseFloat(wrapperStyle.paddingLeft) || 0;
    const paddingRight = parseFloat(wrapperStyle.paddingRight) || 0;
    const availableWidth = Math.max(60, Math.floor(lineWrapper.clientWidth - paddingLeft - paddingRight));

    lineCanvas.style.width = availableWidth + 'px';
    const logicalW = availableWidth;
    const logicalH = 72;
    lineCanvas.width = Math.floor(logicalW * dpr);
    lineCanvas.height = Math.floor(logicalH * dpr);
    lineCanvas.style.height = logicalH + 'px';

    const ctx = lineCanvas.getContext('2d');
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, logicalW, logicalH);

    const barH = 18, barY = 18, radius = 6;
    const grad = ctx.createLinearGradient(0, 0, logicalW, 0);
    grad.addColorStop(0.00, '#ef5350');
    grad.addColorStop(0.25, '#ffeb3b');
    grad.addColorStop(0.50, '#4caf50');
    grad.addColorStop(0.75, '#4285f4');
    grad.addColorStop(1.00, '#9b4dff');

    ctx.beginPath();
    ctx.moveTo(radius, barY);
    ctx.lineTo(logicalW - radius, barY);
    ctx.quadraticCurveTo(logicalW, barY, logicalW, barY + radius);
    ctx.lineTo(logicalW, barY + barH - radius);
    ctx.quadraticCurveTo(logicalW, barY + barH, logicalW - radius, barY + barH);
    ctx.lineTo(radius, barY + barH);
    ctx.quadraticCurveTo(0, barY + barH, 0, barY + barH - radius);
    ctx.lineTo(0, barY + radius);
    ctx.quadraticCurveTo(0, barY, radius, barY);
    ctx.closePath();

    ctx.fillStyle = grad;
    ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.06)';
    ctx.stroke();

    const posX = Math.max(6, Math.min(logicalW - 6, (score / 100) * logicalW));
    const posY = barY + barH / 2;
    ctx.beginPath();
    ctx.arc(posX, posY, 6, 0, Math.PI * 2);
    ctx.fillStyle = '#000';
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#fff';
    ctx.stroke();

    ctx.font = '10px Arial';
    ctx.fillStyle = '#000';
    ctx.textAlign = 'center';
    ctx.fillText(score + '%', posX, barY + barH + 14);

    const ticks = [0, 25, 50, 75, 100];
    ctx.font = '10px Arial';
    ctx.fillStyle = '#333';
    ctx.textAlign = 'center';
    ticks.forEach(t => {
      let x = (t / 100) * logicalW;
      if (t === 0) x = 12;
      if (t === 100) x = logicalW - 12;
      ctx.beginPath();
      ctx.moveTo(x, barY + barH);
      ctx.lineTo(x, barY + barH + 6);
      ctx.strokeStyle = '#666';
      ctx.lineWidth = 1;
      ctx.stroke();
      ctx.fillText(String(t), x, barY + barH + 26);
    });

    ctx.font = '11px Arial';
    ctx.fillStyle = '#111';
    ctx.textAlign = 'left';
    ctx.fillText('Poor', 6, barY - 6);
    ctx.textAlign = 'center';
    ctx.fillText('Good', logicalW / 2, barY - 6);
    ctx.textAlign = 'right';
    ctx.fillText('Excellent', logicalW - 6, barY - 6);
  }

  // ---------- Fetch + render ----------
  async function loadTrustData() {
    try {
      const resp = await fetch(API_URL);
      if (!resp.ok) { console.error("API error", resp.statusText); return; }
      const j = await resp.json();
      const trust = j.trust || { params:{}, overall:0 };
      const overall = Math.round(Number(trust.overall || 0));
      window.LATEST_OVERALL = overall;

      // ðŸ”¹ Inject user name + id into top bar
      if (j.meta) {
        const topBarTitle = document.getElementById("topBarTitle");
        const userInfo = document.getElementById("userInfo");
        if (topBarTitle && userInfo) {
          topBarTitle.innerText = "Trustscore Analysis";
          userInfo.innerHTML = `${j.meta.user_name} (ID: ${j.meta.user_id})`;           
        }
      }
      updateParamCards(trust.params || {});
      renderDonut(overall);
      drawTrustLine(overall);
    } catch (e) {
      console.error("Fetch failed", e);
    }
  }

  loadTrustData();
  if (refreshBtn) refreshBtn.addEventListener('click', loadTrustData);

  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      let score = 0;
      try { score = Number(donutChart.data.datasets[0].data[0]); } catch(e){}
      drawTrustLine(score || 0);
    }, 150);
  });
});
</script>


<!-- Trend script -->
<script>
(function () {
  // Chart instance ko global pe rakhte hain taaki recreate na karna pade
  let chartInstance = null;

  // Helper: date formatting (yyyy-mm-dd) â€” agar API alag format de toh adjust karo
  function formatLabel(dateStr) {
    try {
      const d = new Date(dateStr);
      if (isNaN(d)) return dateStr;
      return d.toLocaleDateString(); // browser locale ke hisaab se readable
    } catch (e) {
      return dateStr;
    }
  }

  async function loadScoreTrend() {
    const groupSlug = "{{ group_slug }}"; // server-side templating
    const userId = "{{ user_id }}";       // server-side templating
    if (!groupSlug || !userId) {
      console.warn("Missing group_slug or user_id for trustscore trend.");
      return;
    }

    const url = `/api/coops/${encodeURIComponent(groupSlug)}/trustscore/trend/${encodeURIComponent(userId)}`;

    try {
      const resp = await fetch(url, { cache: "no-store" });
      if (!resp.ok) {
        console.error("Failed to fetch trend:", resp.status, resp.statusText);
        return;
      }

      const data = await resp.json();
      if (!Array.isArray(data) || data.length === 0) {
        // show placeholder / clear chart
        if (chartInstance) {
          chartInstance.data.labels = [];
          chartInstance.data.datasets[0].data = [];
          chartInstance.update();
        }
        console.info("No trend data available.");
        return;
      }

      const labels = data.map(d => formatLabel(d.date ?? d.label ?? ""));
      const scores = data.map(d => {
        const s = Number(d.score);
        return Number.isFinite(s) ? s : null;
      });

      // ensure canvas exists
      const canvas = document.getElementById("scoreTrend");
      if (!canvas) {
        console.error("#scoreTrend canvas not found in DOM.");
        return;
      }
      const ctx = canvas.getContext("2d");

      // If chart already exists, update it; else create new
      if (chartInstance) {
        chartInstance.data.labels = labels;
        chartInstance.data.datasets[0].data = scores;
        chartInstance.update();
      } else {
        // eslint-disable-next-line no-undef
        chartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [{
              label: "Trust Score",
              data: scores,
              borderColor: "#4285f4",
              backgroundColor: "rgba(66,133,244,0.15)",
              tension: 0.3,
              fill: true,
              pointRadius: 4,
              pointBackgroundColor: "#4285f4",
              pointBorderColor: "#fff",
              pointBorderWidth: 2,
              spanGaps: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                suggestedMin: 0,
                suggestedMax: 100,
                beginAtZero: true,
                ticks: { stepSize: 10 }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const v = context.parsed.y;
                    return (v === null || v === undefined) ? "No value" : `Trust Score: ${v.toFixed(2)}`;
                  }
                }
              }
            }
          }
        });

        // expose for debugging if needed
        window.scoreTrendChart = chartInstance;
      }
    } catch (err) {
      console.error("Trend load failed:", err);
    }
  }

  // Load on DOM ready
  document.addEventListener("DOMContentLoaded", loadScoreTrend);
  // Optional: expose reload function (useful for manual refresh)
  window.reloadTrustScoreTrend = loadScoreTrend;
})();
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
  tooltipTriggerList.map(el => new bootstrap.Tooltip(el))
});
</script>

<script>
async function loadLoanVsRepayment() {
  try {
    const url = `/api/coops/{{ group_slug }}/loans/with-repayments?user_id={{ user_id }}`;
    const resp = await fetch(url);
    if (!resp.ok) return;
    const raw = await resp.json();

    // Normalize + clamp (no negative bars)
    const rows = raw.map(r => {
      const principal   = +r.principal || 0;
      const repaid      = +r.repaid || 0;
      const overpay     = Math.max(0, repaid - principal);
      const balanceDue  = Math.max(0, principal - repaid);   // âœ… new name
      let status = balanceDue === 0 ? (overpay ? 'Overpaid' : 'Closed') : 'Active';
      return { ...r, principal, repaid, balanceDue, overpay, status };
    });

    const CURRENCY = 'â‚¹';
    const fmt = v => CURRENCY + Number(v || 0).toLocaleString();

    const ctx = document.getElementById("loanVsRepayment").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: rows.map(r => r.created_at || ("Loan #" + r.loan_id)),
        datasets: [
          { label: "Loan Amount", data: rows.map(r => r.principal), backgroundColor: "#3f51b5" },
          { label: "Repaid",      data: rows.map(r => r.repaid),    backgroundColor: "#ff9800" },
          { label: "Balance Due", data: rows.map(r => r.balanceDue),   // âœ… updated
            type: "line", borderColor: "#4caf50", borderWidth: 2, fill: false, pointRadius: 3 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { y: { beginAtZero: true, title: { display: true, text: `Amount (${CURRENCY})` } } },
        plugins: {
          legend: { labels: { usePointStyle: true } },
          tooltip: {
            callbacks: {
              afterBody: items => {
                const r = rows[items[0].dataIndex];
                const lines = [
                  `Status: ${r.status}`,
                  `Loan Amount: ${fmt(r.principal)}`,
                  `Repaid: ${fmt(r.repaid)}`,
                  `Balance Due: ${fmt(r.balanceDue)}`   // âœ… updated
                ];
                if (r.overpay > 0) lines.push(`Credit held: ${fmt(r.overpay)}`);
                return lines;
              }
            }
          }
        }
      }
    });
  } catch (e) {
    console.error("Loan vs Repayment load failed", e);
  }
}
document.addEventListener("DOMContentLoaded", loadLoanVsRepayment);
</script>


<script>
async function loadComponentBreakdown(){
  const resp = await fetch(`/api/coops/{{ group_slug }}/trustscore/weekly/{{ user_id }}`);
  if(!resp.ok) return;
  const j = await resp.json();
  const params = j.trust?.params || {};

  // keep only numeric metrics (skip null/undefined)
  const entries = Object.entries(params)
    .filter(([_, v]) => typeof v === 'number' && !Number.isNaN(v))
    .map(([k, v]) => [k, Math.max(0, Math.min(100, Math.round(v)))]);

  const labels = entries.map(([k]) => k);
  const values = entries.map(([_, v]) => v);

  const ctx = document.getElementById("componentBreakdown").getContext("2d");
  new Chart(ctx,{
    type:"pie",
    data:{
      labels,
      datasets:[{
        data: values,
        backgroundColor:["#4caf50","#ff9800","#2196f3","#9c27b0","#f44336","#00bcd4","#8bc34a","#ffc107","#3f51b5","#e91e63"]
      }]
    },
    options:{
      responsive:true,
      maintainAspectRatio:false,
      layout:{ padding:{ right:20 } },
      plugins:{ legend:{ position:"right", labels:{ boxWidth:18, padding:14, usePointStyle:true, font:{size:12} } } }
    }
  });
}
document.addEventListener("DOMContentLoaded", loadComponentBreakdown);
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnExport").addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF("p", "mm", "a4");

    // âœ… à¤¸à¤¿à¤°à¥à¤«à¤¼ container à¤•à¥‹ à¤²à¥‹ (fallback à¤•à¥‡ à¤¸à¤¾à¤¥)
    const dashboard =
      document.querySelector(".container.py-4") ||
      document.querySelector(".container") ||
      document.body;

    // High-res canvas + white background
    const canvas = await html2canvas(dashboard, {
      scale: 2,
      backgroundColor: "#ffffff",
      useCORS: true
    });
    const imgData = canvas.toDataURL("image/png");

    // âœ… A4 à¤®à¥‡à¤‚ proper margins à¤•à¥‡ à¤¸à¤¾à¤¥ fit
    const pageW = doc.internal.pageSize.getWidth();   // 210mm
    const pageH = doc.internal.pageSize.getHeight();  // 297mm
    const margin = 12;                                 // 12mm margin
    const imgW = pageW - margin * 2;
    const imgH = (canvas.height * imgW) / canvas.width;

    let heightLeft = imgH;
    let position = margin;

    doc.addImage(imgData, "PNG", margin, position, imgW, imgH);
    heightLeft -= (pageH - margin * 2);

    while (heightLeft > 0) {
      doc.addPage();
      position = margin - (imgH - heightLeft);
      doc.addImage(imgData, "PNG", margin, position, imgW, imgH);
      heightLeft -= (pageH - margin * 2);
    }

    doc.save("trustscore_dashboard.pdf");
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const backBtn = document.getElementById('btnBack');
  if (!backBtn) return;
  backBtn.addEventListener('click', (e) => {
    e.preventDefault();
    if (window.history.length > 1) {
      window.history.back();
    } else {
      // fallback (edit path if needed)
      window.location.assign(`/group/{{ group_slug }}`);
    }
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('logout-btn');
  if (!btn) return;
  btn.addEventListener('click', async () => {
    try {
      const r = await fetch('/api/users/logout', { method: 'POST', credentials: 'include' });
      // success ya na ho, home pe bhej do:
      window.location.assign('/');
    } catch { window.location.assign('/'); }
  });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
