<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Co-op Group Dashboard</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    :root{
      --sidebar-dark:#111827;
      --sidebar-dark-2:#0f172a;
      --navy-900:#0b3a6d;
      --border:#e5e7eb;
      --border-dark:#0b1220;
      --bg:#f5f7fb;
    }

    body{ background:var(--bg); }

    /* ===== Shell with breathing room between sidebar & content ===== */
    .coop-app{
      display:grid;
      grid-template-columns: 360px minmax(0,1fr); /* roomy sidebar */
      column-gap: 24px;                            /* space between */
      min-height: 100vh;
    }
    @media (min-width:1500px){
      .coop-app{ grid-template-columns: 380px minmax(0,1fr); column-gap:28px; }
    }

    /* ===== Topbar ===== */
    .topbar{
      background:var(--navy-900); color:#fff; position:sticky; top:0; z-index:1030;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar .brand{ font-weight:700; letter-spacing:.2px; color:#fff; }
    .topbar .brand i{ font-size:1.2rem; margin-right:.35rem; }

    /* ===== Sidebar ===== */
    .coop-sidebar{
      background:linear-gradient(180deg,var(--sidebar-dark),var(--sidebar-dark-2));
      border-right:1px solid var(--border-dark);
      color:#e5e7eb;
      min-height: calc(100vh - 56px); /* 56px ~ topbar height */
      position:sticky; top:56px;
      display:flex; flex-direction:column;
    }
    .coop-sidebar .section-title { font-size: .78rem; letter-spacing: .08em; text-transform: uppercase; color: #9ca3af; margin: .9rem 0 .5rem; padding: 0 1rem; }
.brand-badge {
  width: 40px;
  height: 40px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 12px;
  background: #0ea5a6;
  color: #062a2a;
  box-shadow: 0 10px 24px rgba(14,165,166,.35);
  font-size: 1.2rem;
  flex-shrink: 0;  /* text ke pressure se chhote na ho */
}

.brand-area {
  padding: 2rem 1.25rem;
  border-bottom: 1px solid rgba(255,255,255,0.25);
  min-height: 110px;
  display: flex;              /* row layout */
  align-items: center;        /* vertical center */
  gap: 1rem;                  /* badge aur text ke beech space */
}

.brand-area h5 {
  color: #fff;
  font-weight: 700;
  font-size: 1.25rem;
  margin: 0 0 .25rem;
}

.brand-area .small {
  color: #d1d5db;
  font-size: .9rem;
}
.menu{
  padding:1rem 0.7rem 1.25rem;
  display:flex;
  flex-direction:column;
  gap:1.2rem;   /* ‚¨ÖÔ∏è yahi line add karo vertical spacing ke liye */
}
.menu .nav-link{
  color:#e5e7eb;
  border-radius:.7rem;
  display:flex;
  align-items:center;
  gap:.75rem;
  padding:.6rem .75rem;
  font-weight:500;
}

    .menu .nav-link i{ font-size:1rem; opacity:.9; }
    .menu .nav-link:hover{ background:rgba(255,255,255,.06); }
    .menu .nav-link.active{ background:#0b3a6d; color:#fff; }

    /* ===== Main ===== */
    .coop-main{
      padding: 16px 20px;   /* outer breathing */
    }
    .coop-main-inner{
      background:transparent;
      padding: 8px 20px;    /* keep your card spacing */
    }

    /* üîß Alignment helper:
       Content header spacer matches sidebar brand + top padding
       so tables start level with the first menu item */
    .content-align-spacer{
      height: 14px; /* fine-tuned to align rows with sidebar menu */
    }

    /* Cards/Tables (reuse your existing styles) */
    .summary-card{ border-radius:10px; }
    .muted { color:#2563eb; }  /* blue */
    .pill{
      background:#f3f8ff; border:1px solid #e1ecff; border-radius:999px;
      padding:.25rem .6rem; font-size:.875rem;
    }
.table{
  border-collapse: separate !important;
  border-spacing: 0 12px !important;   /* row gap */
  background: transparent;
}

.table thead th{
  background: transparent !important;
  border: 0 !important;
  border-top: 2px solid #e5e7eb !important; /* top blue line */
  color: #0b3a6d;
  font-weight: 700;
  padding-top: 10px;
  padding-bottom: 8px;
}

.table td{
  background: #d7e3eb;   /* light blue bar */
  border: 0 !important;
  padding: 6px 8px;
}

.table tbody td:first-child{
  border-top-left-radius: 8px;
  border-bottom-left-radius: 8px;
}
.table tbody td:last-child{
  border-top-right-radius: 8px;
  border-bottom-right-radius: 8px;
}

.table tbody tr:hover td{
  background: #cddbe6;
}


    /* Mobile: hide sidebar for simple view */
    @media (max-width: 991.98px){
      .coop-app{ grid-template-columns: 1fr; column-gap:0; }
      .coop-sidebar{ display:none; }
      .coop-main{ padding:12px; }
      .coop-main-inner{ padding: 0; }
      .content-align-spacer{ height: 0; }
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar py-2">
    <div class="container-fluid d-flex align-items-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-2 brand">
        <i class="bi bi-bank2"></i><span>Co-op Dashboard</span>
      </div>
      <div class="d-flex align-items-center gap-3">
        <a class="btn btn-outline-light btn-sm" href="/chatbot">
          <i class="bi bi-robot me-1"></i> Chatbot
        </a>

      </div>

    </div>
  </header>

<div class="coop-app">
  <!-- Sidebar -->
  <aside class="coop-sidebar">
    <div class="brand-area">
      <span class="brand-badge"><i class="bi bi-shield-lock"></i></span>
      <div class="brand-text">
        <h5 id="title" class="mb-0">Group</h5>
        <div id="slugline" class="small"></div>
      </div>
    </div>
    <!-- ...menu continues -->

      <nav class="menu nav flex-column" id="groupTabs">
          <div class="section-title">Menu</div>
        <a class="nav-link active" data-bs-toggle="tab" href="#membersTab"><i class="bi bi-people"></i> Members</a>
        <a class="nav-link" data-bs-toggle="tab" href="#depositsTab"><i class="bi bi-download"></i> Deposits</a>
        <a class="nav-link" data-bs-toggle="tab" href="#loansTab"><i class="bi bi-file-earmark-text"></i> Loans</a>
        <a class="nav-link" data-bs-toggle="tab" href="#votesTab"><i class="bi bi-check2-square"></i> Voting</a>
        <a class="nav-link" data-bs-toggle="tab" href="#repaymentsTab"><i class="bi bi-arrow-counterclockwise"></i> Repayments</a>
        <a class="nav-link" data-bs-toggle="tab" href="#ledgerTab"><i class="bi bi-journal-text"></i> Ledger</a>
        <a class="nav-link" data-bs-toggle="tab" href="#alertsTab"><i class="bi bi-bell"></i> Alerts</a>
        <a class="nav-link" data-bs-toggle="tab" href="#balancesTab"><i class="bi bi-wallet2"></i> Balances</a>
        <a class="nav-link" data-bs-toggle="tab" href="#withdrawalsTab"><i class="bi bi-cash"></i> Withdrawals</a>
        <a class="nav-link" data-bs-toggle="tab" href="#creditsTab"><i class="bi bi-plus-circle"></i> Credits</a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="coop-main">
      <div class="coop-main-inner container-fluid px-0">
        <!-- spacer to align tables with sidebar menu level -->
        <div class="content-align-spacer"></div>

        <!-- Summary cards -->
        <div class="row g-3 mb-4 px-3">
          <div class="col-md-3">
            <div class="card summary-card shadow-sm text-center p-3">
              <div class="muted"><i class="bi bi-cash-coin me-1"></i> Vault Balance</div>
              <h5 id="sumBalance">‚Äî</h5>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card summary-card shadow-sm text-center p-3">
              <div class="muted"><i class="bi bi-people me-1"></i> Members</div>
              <h5 id="sumMembers">‚Äî</h5>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card summary-card shadow-sm text-center p-3">
              <div class="muted"><i class="bi bi-file-earmark-text me-1"></i> Active Loans</div>
              <h5 id="sumLoans">‚Äî</h5>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card summary-card shadow-sm text-center p-3">
              <div class="muted"><i class="bi bi-bell me-1"></i> Alerts</div>
              <h5 id="sumAlerts">‚Äî</h5>
            </div>
          </div>
        </div>

        <!-- Rules -->
        <div class="row g-3 mb-4 px-3">
          <div class="col-12">
            <div class="card shadow-sm p-3">
              <h5 class="mb-3">üìú Group Rules</h5>
              <div class="row text-center">
                <div class="col-md-6">
                  <div class="pill">Interest Rate</div>
                  <h6 id="ruleInterest" class="mt-2">‚Äî</h6>
                </div>
                <div class="col-md-6">
                  <div class="pill">Minimum Balance</div>
                  <h6 id="ruleMinBalance" class="mt-2">‚Äî</h6>
                </div>
              </div>
            </div>
          </div>
        </div>


        <div class="tab-content">
            <!-- Members -->
            <div class="tab-pane fade show active" id="membersTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Role</th>
                            <th>Joined</th>
                            <th class="text-center">Trust</th>
                        </tr>
                    </thead>
                    <tbody id="membersBody">
                        <tr>
                            <td colspan="4">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Deposits -->
            <div class="tab-pane fade" id="depositsTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="depositsBody">
                        <tr>
                            <td colspan="3">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Balances -->
            <div class="tab-pane fade" id="balancesTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Total Deposit</th>
                            <th>Interest</th>
                            <th>Withdrawn</th>
                            <th>Net Balance</th>
                        </tr>
                    </thead>
                    <tbody id="balancesBody">
                        <tr>
                            <td colspan="5">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Withdrawals -->
            <div class="tab-pane fade" id="withdrawalsTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Interest</th>
                            <th>Total Paid</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawalsBody">
                        <tr>
                            <td colspan="5">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Credits -->
            <div class="tab-pane fade" id="creditsTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Loan</th>
                            <th>Amount</th>
                            <th>Source</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="creditsBody">
                        <tr>
                            <td colspan="6">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <!-- Loans -->
            <div class="tab-pane fade" id="loansTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="loansBody">
                        <tr>
                            <td colspan="4">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Voting -->
            <div class="tab-pane fade" id="votesTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>Loan ID</th>
                            <th>Yes</th>
                            <th>No</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="votesBody">
                        <tr>
                            <td colspan="4">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

<!-- Repayments -->
<div class="tab-pane fade" id="repaymentsTab">
    <table class="table table-sm excel-table">
        <thead>
            <tr>
                <th>Loan</th>
                <th>User</th>
                <th>Amount</th>
                <th>Date</th>
            </tr>
        </thead>
        <tbody id="repaymentsBody">
            <tr>
                <td colspan="4">Loading‚Ä¶</td>
            </tr>
        </tbody>
    </table>
</div>

            <!-- Ledger -->
            <div class="tab-pane fade" id="ledgerTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>User</th>
                            <th>Amount</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="ledgerBody">
                        <tr>
                            <td colspan="4">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Alerts -->
            <div class="tab-pane fade" id="alertsTab">
                <table class="table table-sm excel-table">
                    <thead>
                        <tr>
                            <th>Message</th>
                            <th>Level</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="alertsBody">
                        <tr>
                            <td colspan="3">Loading‚Ä¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </main>
</div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SLUG = {{ slug | tojson or 'null' }};
if (!SLUG || SLUG === 'null') {
    alert('Group slug missing');
    throw new Error('Group slug missing');
}

const token = localStorage.getItem('jwt_token');

async function authFetch(url, opts = {}) {
    const token = localStorage.getItem('jwt_token');

    if (!token || token.split('.').length !== 3) {
        // JWT missing or invalid format
        alert("‚ö†Ô∏è Invalid or missing login. Please login again.");
        localStorage.removeItem('jwt_token');
        window.location.href = "/api/users/auth";
        return null;
    }

    const res = await fetch(url, {
        ...opts,
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...(opts.headers || {})
        }
    });

    if (res.status === 401) {
        alert("Please login again");
        localStorage.removeItem('jwt_token');
        window.location.href = "/api/users/auth";
        return null;
    }

    return res;
}


function fmtDate(d) {
    if (!d) return "‚Äî";
    return new Date(d).toLocaleString();
}
</script>

<!-- 2. Load Group -->
<script>
async function loadGroup() {
    const res = await authFetch(`/api/coops/${SLUG}`);
    if (!res) return;
    const data = await res.json();
    if (data.error) {
        alert(data.error);
        return;
    }

    const g = data.group;
    document.getElementById("title").textContent = g.name;
    document.getElementById("slugline").innerHTML =
    `Slug: <span class="mono">${g.slug}</span><br>Vault: <span class="mono">${g.cooperative_account_id || "‚Äî"}</span>`;



    // üîπ Save group_id globally
    window.GROUP_ID = g.id;

// ‚úÖ Rules display
if (g.rules) {
    document.getElementById("ruleInterest").textContent =
        g.rules.interest_rate ? `${g.rules.interest_rate.toFixed(2)}% per year` : "‚Äî";
    document.getElementById("ruleMinBalance").textContent =
        g.rules.min_balance ? `${g.rules.min_balance} BHC` : "‚Äî";
}


// Render members with Trust button, and open Trust Dashboard on click
const body = document.getElementById("membersBody");
body.innerHTML = "";
(g.members || []).forEach(m => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
        <td class="mono">${m.user_id}</td>
        <td>${m.role}</td>
        <td>${m.joined_at}</td>
        <td class="text-center">
            <button class="btn btn-sm btn-outline-primary trust-btn" data-user-id="${m.user_id}">
                <i class="bi bi-shield-lock"></i> Trust
            </button>
        </td>
    `;
    body.appendChild(tr);
});

document.getElementById("sumMembers").textContent = g.members.length;

document.addEventListener('click', function(e){
    const btn = e.target.closest('.trust-btn');
    if (!btn) return;
    const userId = btn.getAttribute('data-user-id');
    window.location.href = `/group/${SLUG}/member/${userId}/trust`;
});





    loadBalance();
    loadDeposits();
    loadLoans();
    loadVotes();
    loadRepayments();
    loadLedger();
    loadAlerts();
    loadBalances();
    loadWithdrawals();
    loadCredits();
}
</script>

<!-- 3. Vault Balance -->
<script>
async function loadBalance() {
    const res = await authFetch(`/api/coops/${SLUG}/balance`);
    if (!res) return;
    const b = await res.json();
    const bhcPart = (b.bhc && b.bhc.display != null) ? `${b.bhc.display} BHC` : "‚Äî";
    document.getElementById("sumBalance").textContent = bhcPart;
}
</script>

<!-- 4. Deposits -->
<script>
async function loadDeposits() {
    const res = await authFetch(`/api/coops/${SLUG}/deposits`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("depositsBody");
    body.innerHTML = "";

    if (rows.length === 0) {
        body.innerHTML = `<tr><td colspan="3">No deposits yet</td></tr>`;
        return;
    }

    rows.forEach(d => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${d.user_id}</td>
            <td>${d.amount}</td>
            <td>${fmtDate(d.created_at)}</td>
        `;
        body.appendChild(tr);
    });
}
</script>

<!-- 5. Loans -->
<script>
async function loadLoans() {
    const res = await authFetch(`/api/coops/${SLUG}/loans`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("loansBody");
    body.innerHTML = "";

    rows.forEach(l => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${l.user_id}</td>
            <td>${l.amount}</td>
            <td>${l.status}</td>
            <td>${fmtDate(l.created_at)}</td>
        `;
        body.appendChild(tr);
    });

    document.getElementById("sumLoans").textContent =
        rows.filter(r => r.status === "approved").length;
}
</script>

<!-- 6. Votes -->
<script>
async function loadVotes() {
    const res = await authFetch(`/api/coops/${SLUG}/votes`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("votesBody");
    body.innerHTML = "";

    rows.forEach(v => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${v.loan_request_id}</td>
            <td>${v.yes}</td>
            <td>${v.no}</td>
            <td>${v.status}</td>
        `;
        body.appendChild(tr);
    });
}
</script>

<!-- 7. Repayments (fixed) -->
<script>
async function loadRepayments() {
  try {
    const res = await authFetch(`/api/coops/${SLUG}/repayments`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("repaymentsBody");
    body.innerHTML = "";

    if (!rows || rows.length === 0) {
      body.innerHTML = `<tr><td colspan="4">No repayments yet</td></tr>`;
      return;
    }

    rows.forEach(r => {
      const loanId = r.loan_id ?? "-";
      const payer = r.payer_id ?? "-";
      const amount = (typeof r.amount === "number") ? r.amount : parseFloat(r.amount || 0);
      const created = r.created_at ? new Date(r.created_at) : null;
      const dateStr = created ? created.toLocaleString() : "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${loanId}</td>
        <td>${payer}</td>
        <td>${amount.toFixed(2)} BHC</td>
        <td>${dateStr}</td>
      `;
      body.appendChild(tr);
    });
  } catch (err) {
    console.error("loadRepayments error", err);
    const body = document.getElementById("repaymentsBody");
    if (body) body.innerHTML = `<tr><td colspan="4">Error loading repayments</td></tr>`;
  }
}
</script>


<!-- 8. Ledger + Alerts -->
<script>
async function loadLedger() {
    const res = await authFetch(`/api/coops/${SLUG}/ledger`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("ledgerBody");
    body.innerHTML = "";

    rows.forEach(tx => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${tx.ref_type}</td>
            <td>${tx.user_id}</td>
            <td>${tx.amount}</td>
            <td>${fmtDate(tx.created_at)}</td>
        `;
        body.appendChild(tr);
    });
}

async function loadAlerts() {
    const res = await authFetch(`/api/coops/${SLUG}/alerts`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("alertsBody");
    body.innerHTML = "";

    rows.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${a.message}</td>
            <td>${a.level}</td>
            <td>${fmtDate(a.created_at)}</td>
        `;
        body.appendChild(tr);
    });

    document.getElementById("sumAlerts").textContent = rows.length;
}
</script>

<!-- 9. Balances + Withdrawals -->
<script>
async function loadBalances() {
    const res = await authFetch(`/api/coops/${SLUG}/balances`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("balancesBody");
    body.innerHTML = "";

    if (!rows || rows.length === 0) {
        body.innerHTML = `<tr><td colspan="5">No balance found</td></tr>`;
        return;
    }

    rows.forEach(b => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${b.user_id}</td>
            <td>${Number(b.total_deposit || 0).toFixed(2)}</td>
            <td>${Number(b.interest_earned || 0).toFixed(2)}</td>
            <td>${Number(b.total_withdrawn || 0).toFixed(2)}</td>
            <td>${Number(b.net_balance || 0).toFixed(2)}</td>
        `;
        body.appendChild(tr);
    });
}

async function loadWithdrawals() {
    const res = await authFetch(`/api/coops/${SLUG}/withdrawals`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("withdrawalsBody");
    body.innerHTML = "";

    if (!rows || rows.length === 0) {
        body.innerHTML = `<tr><td colspan="5">No withdrawals yet</td></tr>`;
        return;
    }

    rows.forEach(w => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${w.user_id}</td>
            <td>${Number(w.amount || 0).toFixed(2)}</td>
            <td>${(w.interest === null || w.interest === undefined) ? "‚Äî" : Number(w.interest).toFixed(2)}</td>
            <td>${Number(w.total_paid || 0).toFixed(2)}</td>
            <td>${fmtDate(w.created_at)}</td>
        `;
        body.appendChild(tr);
    });
}
</script>


<!-- 10. Credits + Init -->
<script>
// ---------- Credits ----------
async function loadCredits() {
    if (!window.GROUP_ID) {
        console.error("Group ID not loaded yet");
        return;
    }
    const res = await authFetch(`/api/coops/admin/group/${window.GROUP_ID}/credits`);
    if (!res) return;
    const rows = await res.json();
    const body = document.getElementById("creditsBody");
    body.innerHTML = "";

    if (!Array.isArray(rows) || rows.length === 0) {
        body.innerHTML = `<tr><td colspan="6">No credits yet</td></tr>`;
        return;
    }

    rows.forEach(c => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${c.id}</td>
            <td>${c.user_id}</td>
            <td>${c.loan_id || "-"}</td>
            <td>${c.amount}</td>
            <td>${c.source}</td>
            <td>${fmtDate(c.created_at)}</td>
        `;
        body.appendChild(tr);
    });
}

// ---------- Init ----------
(async function init() {
    if (!token) {
        window.location.href = "/api/users/auth";
        return;
    }
    await loadGroup();
})();
</script>




</body>

</html>